name: Automated Test Creation

on:
  workflow_call:
    inputs:
      mode:
        description: 'Execution mode: direct (commit to current branch) or pr (open pull request)'
        required: false
        type: string
        default: 'pr'
      custom_instructions:
        description: 'Custom instructions for the test generation agent'
        required: false
        type: string
        default: ''
      file_patterns:
        description: 'Comma-separated file patterns to allow writing test files (e.g., "**/*_test.go,**/*_test.py")'
        required: false
        type: string
        default: '**/*_test.go,**/*_test.py,**/test_*.py,**/*.test.ts,**/*.test.js,**/*.spec.ts,**/*.spec.js'
      deny_patterns:
        description: 'Comma-separated file patterns to deny (e.g., "vendor/**,node_modules/**")'
        required: false
        type: string
        default: 'vendor/**,node_modules/**,.git/**,dist/**,build/**'
      pr_branch_prefix:
        description: 'Prefix for test PR branches (only used in pr mode)'
        required: false
        type: string
        default: 'forge/tests'
      max_tokens:
        description: 'Maximum token budget for the LLM execution'
        required: false
        type: number
        default: 2000000
      max_files:
        description: 'Maximum number of test files to create/modify'
        required: false
        type: number
        default: 30
      max_lines_changed:
        description: 'Maximum total lines that can be changed'
        required: false
        type: number
        default: 3000
      model:
        description: 'LLM model to use (e.g. google/gemini-2.5-pro)'
        required: false
        type: string
        default: 'google/gemini-2.5-pro'
      quality_gates:
        description: 'JSON array of quality gate commands to run (e.g., [{"name": "Go Tests", "command": "go test ./..."}, {"name": "Linter", "command": "golangci-lint run"}])'
        required: false
        type: string
        default: '[]'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key (or compatible API key)'
        required: true
      OPENAI_BASE_URL:
        description: 'OpenAI API base URL (for compatible APIs)'
        required: false
      GH_APP_ID:
        description: 'GitHub App ID for generating tokens with PR permissions'
        required: true
      GH_APP_PRIVATE_KEY:
        description: 'GitHub App private key for authentication'
        required: true

jobs:
  create-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Extract PR Context
        id: pr_context
        uses: ./.github/actions/pr-context
        with:
          pr_number: ${{ github.event.pull_request.number || github.event.issue.number }}
          github_token: ${{ steps.app_token.outputs.token }}

      - name: Configure Git
        run: |
          git config --global user.name "anvxl"
          git config --global user.email "anvxl@entr.net.au"

      - name: Generate Forge Configuration
        id: forge_config
        uses: ./.github/actions/forge-config
        with:
          task_description: |
            You are a test creation assistant. Analyze the following pull request and create comprehensive tests for the changes.
            
            Focus on:
            1. Writing tests for new functionality introduced in the PR
            2. Adding test cases for modified functions/methods
            3. Ensuring edge cases and error conditions are covered
            4. Following the project's existing test patterns and conventions
            5. Writing clear, maintainable tests with good descriptions
            6. Including both positive and negative test cases
            7. Testing boundary conditions and error handling
            
            Guidelines:
            - Match the testing framework used in the project (detect from existing tests)
            - Use descriptive test names that explain what is being tested
            - Keep tests focused and independent
            - Add comments explaining complex test scenarios
            - Ensure tests are deterministic and don't rely on external state
          pr_title: ${{ steps.pr_context.outputs.pr_title }}
          pr_body: ${{ steps.pr_context.outputs.pr_body }}
          changed_files: ${{ steps.pr_context.outputs.changed_files }}
          custom_instructions: ${{ inputs.custom_instructions }}
          file_patterns: ${{ inputs.file_patterns }}
          deny_patterns: ${{ inputs.deny_patterns }}
          mode: "write"
          max_tokens: "${{ inputs.max_tokens }}"
          max_files: "${{ inputs.max_files }}"
          max_lines_changed: "${{ inputs.max_lines_changed }}"
          git_mode: "${{ inputs.mode }}"
          git_branch: "${{ inputs.mode == 'pr' && format('{0}-pr-{1}', inputs.pr_branch_prefix, steps.pr_context.outputs.pr_number) || '' }}"
          git_commit_message: "${{ format('test: add tests for PR #{0}', steps.pr_context.outputs.pr_number) }}"
          git_pr_title: "${{ format('test: Add tests for PR #{0}', steps.pr_context.outputs.pr_number) }}"
          git_pr_body: "${{ format('Automated test creation based on changes in #{0}\n\nThis PR adds comprehensive test coverage for the changes introduced in the original PR.', steps.pr_context.outputs.pr_number) }}"
          git_pr_draft: "false"
          quality_gates: '${{ inputs.quality_gates }}'

      - name: Run Forge
        id: forge
        uses: ./.github/actions/forge-runner
        with:
          config_path: ${{ steps.forge_config.outputs.config_path }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          openai_base_url: ${{ secrets.OPENAI_BASE_URL }}
          model: ${{ inputs.model }}
          github_token: ${{ steps.app_token.outputs.token }}

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const exitCode = '${{ steps.forge.outputs.exit_code }}';
            const prNumber = '${{ steps.pr_context.outputs.pr_number }}';
            const mode = '${{ inputs.mode }}';
            
            let comment = '## üß™ Test Creation Results\n\n';
            
            if (exitCode === '0') {
              comment += '‚úÖ Test creation completed successfully!\n\n';
              
              if (mode === 'pr') {
                comment += 'üìù A pull request with new tests has been created.\n';
                comment += '\nPlease review the generated tests to ensure they:\n';
                comment += '- Cover the key functionality from this PR\n';
                comment += '- Follow project testing conventions\n';
                comment += '- Are clear and maintainable\n';
              } else {
                comment += 'üìù Tests have been added directly to this PR.\n';
              }
              
              if ('${{ steps.forge.outputs.artifacts_path }}') {
                comment += '\nüìä Execution artifacts are available in the workflow run.\n';
              }
            } else {
              comment += '‚ùå Test creation failed.\n\n';
              comment += 'Please check the workflow logs for details.\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
