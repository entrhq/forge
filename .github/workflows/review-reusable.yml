name: Automated Code Review

on:
  workflow_call:
    inputs:
      custom_instructions:
        description: 'Custom instructions for the code review agent'
        required: false
        type: string
        default: ''
      max_tokens:
        description: 'Maximum token budget for the LLM execution'
        required: false
        type: number
        default: 1000000
      model:
        description: 'LLM model to use (e.g. google/gemini-2.5-pro)'
        required: false
        type: string
        default: 'google/gemini-2.5-pro'
      file_patterns:
        description: 'Comma-separated file patterns to allow (e.g., "**/*.py,**/*.go")'
        required: false
        type: string
        default: '**/*'
      deny_patterns:
        description: 'Comma-separated file patterns to deny (e.g., "vendor/**,node_modules/**")'
        required: false
        type: string
        default: 'vendor/**,node_modules/**,.git/**,**/*.min.js,**/*.min.css'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key (or compatible API key)'
        required: true
      OPENAI_BASE_URL:
        description: 'OpenAI API base URL (for compatible APIs)'
        required: false
      GH_APP_ID:
        description: 'GitHub App ID for generating tokens with PR permissions'
        required: true
      GH_APP_PRIVATE_KEY:
        description: 'GitHub App private key for authentication'
        required: true

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          fetch-depth: 0

      - name: Extract PR Context
        id: pr_context
        uses: ./.github/actions/pr-context
        with:
          pr_number: ${{ github.event.pull_request.number || github.event.issue.number }}
          github_token: ${{ steps.app_token.outputs.token }}

      - name: Generate Forge Configuration
        id: forge_config
        uses: ./.github/actions/forge-config
        with:
          task_description: |
            You are a code review assistant. Your task is to review PR #${{ steps.pr_context.outputs.pr_number }} and POST COMMENTS using the execute_command tool.
            
            **CRITICAL: You MUST use execute_command to post comments. Reading files alone is NOT sufficient.**
            
            **Review Process - DO THIS ITERATIVELY FILE BY FILE:**
            
            1. **Review One File at a Time:**
               - Read the first changed file
               - Analyze it for issues (bugs, style, security, performance, etc.)
               - IMMEDIATELY post inline comments for that file using execute_command
               - Move to the next file and repeat
               
               This iterative approach ensures comments are posted incrementally, not deferred.
            
            2. **How to Post Inline Comments (USE execute_command):**
               After reviewing each file, if you found issues, POST THEM IMMEDIATELY:
               
               Example for posting inline comments on a single file:
               ```bash
               execute_command with:
               echo '{
                 "event": "COMMENT",
                 "comments": [
                   {
                     "path": "pkg/config/llm.go",
                     "line": 42,
                     "body": "Consider adding validation for empty API keys to prevent runtime errors."
                   },
                   {
                     "path": "pkg/config/llm.go",
                     "line": 67,
                     "body": "This mutex lock could cause contention under high load. Consider using sync.RWMutex for read-heavy scenarios."
                   }
                 ]
               }' | gh api repos/{owner}/{repo}/pulls/${{ steps.pr_context.outputs.pr_number }}/reviews --input -
               ```
               
               **CRITICAL:** Do NOT include a "body" field when posting inline comments - only provide the "comments" array. The "body" field creates announcement comments that clutter the PR.
               
               **Key Review Focus Areas:**
               - Code quality, readability, and maintainability
               - Potential bugs, edge cases, and error handling
               - Performance considerations and optimization opportunities
               - Security vulnerabilities and best practices
               - Architecture and design patterns
               - Test coverage and quality
               - Documentation completeness and accuracy
            
            3. **After Reviewing ALL Files, Post a Summary:**
               Once you've reviewed all files and posted inline comments, use execute_command to post a final summary:
               - Overview of what was reviewed (list the key files and changes)
               - Summary of findings (categorize by severity: critical issues, suggestions, positive observations)
               - Overall assessment of code quality
               - Any cross-cutting concerns or patterns observed
               - Recommendation (approve, request changes, or comment only)
               
               ```bash
               execute_command with:
               gh pr review ${{ steps.pr_context.outputs.pr_number }} --comment -b "
               ## Review Summary
               
               **Files Reviewed:**
               - file1.go: [brief description]
               - file2.go: [brief description]
               
               **Key Findings:**
               
               üî¥ **Critical Issues:** [if any]
               - Issue 1
               - Issue 2
               
               üü° **Suggestions:** [if any]
               - Suggestion 1
               - Suggestion 2
               
               ‚úÖ **Positive Observations:** [if any]
               - Good practice 1
               - Good practice 2
               
               **Overall Assessment:**
               [Your overall evaluation of the PR quality and readiness]
               
               **Recommendation:**
               [Approve / Request Changes / Comment Only]
               "
               ```
            
            **GitHub CLI Commands Reference:**
            - Inline comments: Use API endpoint as shown above
            - Summary comment: `gh pr review ${{ steps.pr_context.outputs.pr_number }} --comment -b "your summary"`
            - Approve: `gh pr review ${{ steps.pr_context.outputs.pr_number }} --approve -b "LGTM! [summary]"`
            - Request changes: `gh pr review ${{ steps.pr_context.outputs.pr_number }} --request-changes -b "Issues found: [summary]"`
            
            **Important Notes:**
            - The GH_TOKEN environment variable is already configured for authentication
            - Always provide both inline comments AND a summary review
            - Be constructive and specific in your feedback
            - Highlight both issues and good practices
            - Use markdown formatting in your comments for better readability
          pr_title: ${{ steps.pr_context.outputs.pr_title }}
          pr_body: ${{ steps.pr_context.outputs.pr_body }}
          changed_files: ${{ steps.pr_context.outputs.changed_files }}
          custom_instructions: ${{ inputs.custom_instructions }}
          file_patterns: ${{ inputs.file_patterns }}
          deny_patterns: ${{ inputs.deny_patterns }}
          mode: "read-only"
          allowed_tools: "read_file,list_files,search_files,execute_command,add_note,list_notes,search_notes,list_tags,scratch_note,update_note"
          max_tokens: "${{ inputs.max_tokens }}"
          git_mode: "none"

      - name: Run Forge
        id: forge
        uses: ./.github/actions/forge-runner
        with:
          config_path: ${{ steps.forge_config.outputs.config_path }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          openai_base_url: ${{ secrets.OPENAI_BASE_URL }}
          model: ${{ inputs.model }}
          github_token: ${{ steps.app_token.outputs.token }}

      - name: Check Review Status
        if: always()
        shell: bash
        run: |
          if [ "${{ steps.forge.outputs.exit_code }}" = "0" ]; then
            echo "‚úÖ Review completed successfully"
            echo "The agent posted review comments directly to the PR using gh CLI"
          else
            echo "‚ùå Review failed with exit code ${{ steps.forge.outputs.exit_code }}"
            exit 1
          fi

      - name: Comment on Failure
        if: always() && steps.forge.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = '${{ steps.pr_context.outputs.pr_number }}';
            
            const comment = '## ü§ñ Automated Code Review\n\n' +
              '‚ùå Review generation failed.\n\n' +
              'Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
